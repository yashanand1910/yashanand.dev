# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: PR (Master)
concurrency:
  cancel-in-progress: true
  group: pr-${{ github.head_ref }}
on:
  pull_request:
    branches:
      - master
jobs:
  build_and_preview:
    name: Test, Build & Deploy Preview
    env:
      NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      FIREBASE_HOSTING_LOGS_URL: 'https://console.firebase.google.com/u/0/project/yashanand-dev/hosting/sites/yashanand-dev'
    if: '${{ github.event.pull_request.head.repo.full_name == github.repository }}'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        name: Checkout

      - name: Start deployment
        if: "!contains(github.head_ref, 'dependabot')"
        uses: bobheadxi/deployments@v0.6.0
        id: start_deployment
        with:
          step: start
          token: ${{ secrets.GITHUB_TOKEN }}
          env: 'Preview (${{ github.head_ref }})'
          logs: ${{ env.FIREBASE_HOSTING_LOGS_URL }}
          ref: ${{ github.head_ref }}

      - run: npm ci
        name: Install

      - run: npm run lint
        name: Check linting

      - run: npm run test:ci
        name: Run unit tests
        continue-on-error: true # Temporary

      - run: npm run build:preview
        name: Build

      - uses: FirebaseExtended/action-hosting-deploy@v0
        name: Deploy preview
        id: deployment
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_YASHANAND_DEV }}'
          projectId: yashanand-dev
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels

      - name: Finish deployment
        uses: bobheadxi/deployments@v0.6.0
        if: ${{ always() && !contains(github.head_ref, 'dependabot')}}
        with:
          step: finish
          token: ${{ secrets.GITHUB_TOKEN }}
          status: ${{ job.status }}
          logs: ${{ env.FIREBASE_HOSTING_LOGS_URL }}
          deployment_id: ${{ steps.start_deployment.outputs.deployment_id }}
          env_url: ${{ steps.deployment.outputs.details_url }}
